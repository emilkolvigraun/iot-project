<!DOCTYPE html>
<html>
    <head>
        <title>IoT Project - Configuration</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="/style/main.css">
        <link rel="stylesheet" type="text/css" href="/style/configuration.css">
    </head>

    <body>
        <div>
            <div class="page-content" >
                    <div class="navbar-div">
                        <ul>
                            <p>IoT Project</p>   
                            <li><a href="/">Start Page</a></li>
                            <li><a class="active" href="/livedata">Live Data</a></li>
                            <li><a href="/rooms">Rooms</a></li>
                        </ul> 
                    </div>
        
                
                <!-- PAGE CONTENT -->
                <div class="content-config">
                    <div style="border-bottom: solid; padding-bottom: 10px;"><font style="margin-left: -400px; font-size: 22px;">Live Data</font></div>
                    <div style="text-align: center;">
                        <!-- CONTENT -->
                        <div class="container">

                            <div class="fixed" style="width:49%; text-align: center;">
                                <font>Room:</font><br>
                                <select id="roomSelect" onchange="renderGraphs()">
                                    <option value="NaN"></option>
                                </select>
                            </div>
                            <div class="flex-item" style="width:49%; text-align: center;">
                                <font>Time period:</font><br>
                                <input type="range" min="1" max="1000" value="0" class="slider" id="fromPeriodSlider" style="width: 90%;"></input>
                                <input type="range" min="1" max="1000" value="1000" class="slider" id="toPeriodSlider" style="width: 90%;"></input>
                                <font style="float:right;" id="fromPeriod">0000 00-00 00:00</font><font id="toPeriod" style="float:left;">0000 00-00 00:00</font>
                            </div>
                        </div>
                        <div id="temperatureGraphContainer" style="height: 300px; width:100%;"></div>
                        <div id="humidityGraphContainer" style="height: 300px; width:100%;"></div>
                        <div id="luxGraphContainer" style="height: 300px; width:100%;"></div>
                        <div id="ventilationGraphContainer" style="height: 300px; width:100%;"></div>
                     </div>
                <div>
            <div>           
    </body>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script>
    

        var temperatureData = [];
        var temperatureGraph = new CanvasJS.Chart("temperatureGraphContainer", {
            title :{ text: "Temperature", fontSize: 22, fontFamily: "tahoma", },
            axisY: { title: "temperature [celcius]", titleFontSize: 18, includeZero: false },  
            axisX: { titleFontSize: 18, title: "Time [Minutes]" },    
            data: [{ type: "line", dataPoints: temperatureData }] });
        var humidityData = [];
        var humidityGraph = new CanvasJS.Chart("humidityGraphContainer", {
            title :{ text: "Humidity", fontSize: 22, fontFamily: "tahoma", },
            axisY: { title: "humidity [g/m^3]", titleFontSize: 18, includeZero: false },  
            axisX: { titleFontSize: 18, title: "Time [Minutes]" },    
            data: [{ type: "line", dataPoints: humidityData }] });
        var luxData = [];
        var luxGraph = new CanvasJS.Chart("luxGraphContainer", {
            title :{ text: "Lighting", fontSize: 22, fontFamily: "tahoma", },
            axisY: { title: "lightlevel [lux]", titleFontSize: 18, includeZero: false },  
            axisX: { titleFontSize: 18, title: "Time [Minutes]" },    
            data: [{ type: "line", dataPoints: luxData }] });
        var ventilationData = [];
        var ventilationGraph = new CanvasJS.Chart("ventilationGraphContainer", {
            title :{ text: "Ventilation Intensity", fontSize: 22, fontFamily: "tahoma", },
            axisY: { title: "power [watt]", titleFontSize: 18, includeZero: false },  
            axisX: { titleFontSize: 18, title: "Time [Minutes]" },    
            data: [{ type: "line", dataPoints: ventilationData }] });

    temperatureGraph.render();
    humidityGraph.render();
    luxGraph.render();
    ventilationGraph.render();

    function getSelectedOption(sel) {
        var opt;
        for ( var i = 0, len = sel.options.length; i < len; i++ ) {
            opt = sel.options[i];
            if ( opt.selected === true ) {
                break;
            }
        }
        return opt;
    }

    function http(url, httptype, payload) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open(httptype, url, false); 
        xmlHttp.setRequestHeader('Content-type','application/json; charset=utf-8');
        response = undefined;
        xmlHttp.onload = function () {
                response =  xmlHttp.responseText;
        }
        xmlHttp.send(payload);
        return response
    }

    function parseStringToList(string){
        string = string.replace("[", "").replace("]", "");
        string = string.split("'").join("");
        return string.split(",");
    }

    function contains(a, obj) {
        var i = a.length;
        while (i--) {
        if (a[i].trim() === obj.trim()) {
            return true;
        }
        }
        return false;
    }

    function updateRoomContent(){
        rooms = http("http://127.0.0.1:8000/configuration/rooms/get", "GET", null);
        rooms = parseStringToList(rooms);
        select = document.getElementById("roomSelect");
        selection = getSelectedOption(select);
        if (contains(rooms, selection.value)){
            select.innerHTML = "<option style="+'"font-weight: bold;"'+"value="+ selection.value +">"+selection.value+"</option>";
        } else {
            select.innerHTML = "<option value=NaN></option>";
        }
        for (i = 0; i < rooms.length; i++){
            select.innerHTML += "<option value="+ rooms[i] +">"+ rooms[i] +"</option>";
        }
    }

    function renderGraphs(){
        console.log("render");
        console.log("send time from and to, to get data");
    }

    function updateRooms(){
        updateRoomContent();
        setTimeout(updateRooms, 1000);
    }

    updateRooms();

    </script>
</html>
