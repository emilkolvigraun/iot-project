<!DOCTYPE html>
<html>
    <head>
        <title>IoT Project - Alerts</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="/style/main.css">
        <link rel="stylesheet" type="text/css" href="/style/configuration.css">
    </head>

    <body onchange="initialize()">
        <div>
            <div class="page-content" >
                    <div class="navbar-div">
                        <ul>
                            <p>IoT Project</p>
                            <li><a href="/">Start Page</a></li>
                            <li><a class="active" href="/alert">Alerts</a></li>
                            <li><a href="/livedata">Live Data</a></li>
                            <li><a href="/rooms">Rooms</a></li>
                        </ul> 
                    </div>
        
                
                <!-- PAGE CONTENT -->
                <div class="content-config">
                    <div style="border-bottom: solid; padding-bottom: 10px;"><font style="margin-left: -400px; font-size: 22px;">Notifications</font></div>
                    <div id="alert_div" onchange="updateAlerts()"></div>
                <div>
            <div>           
    </body>

    <script>

        var authenticated = false;
        var client = null;
        
        function http(url, httptype, payload) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open(httptype, url, false); 
            xmlHttp.setRequestHeader('Content-type','application/json; charset=utf-8');
            response = undefined;
            xmlHttp.onload = function () {
                    response =  xmlHttp.status;
            }
            xmlHttp.send(payload);
            return response
        }

        function connectClient(){
            client = new Paho.MQTT.Client("192.168.0.45", 8001, create_UUID());
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            client.connect();
        }

        function create_UUID(){
            var dt = new Date().getTime();
            var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = (dt + Math.random()*16)%16 | 0;
                dt = Math.floor(dt/16);
                return (c=='x' ? r :(r&0x3|0x8)).toString(16);
            });
            return uuid;
        }

        function updateAlerts(){
            alertDiv = document.getElementById('alert_div');
            payload = JSON.parse(http("http://192.168.0.45:8000/alerts/get", "GET", null));
            getAlerts = payload["alert"]
            console.log("Current alerts: " + getAlerts);
            alertDiv.innerHTML = "<span>" + payload + "</span>";
        }



        function getCookie(cookieKey) {
            var cookies = document.cookie.toString();
            cookies = cookies.split(";");
            for (i = 0; i < cookies.length; i++){
                cookie = cookies[i].split("=");
                key = cookie[0];
                if (key == cookieKey){
                    return cookie[1];
                }
            }
            return "";
        }

        function checkCookie(){
            var cookie = getCookie('status');
            
            select = document.getElementById("roomSelect")
            newRoomBtn = document.getElementById("newRoom")
            deleteRoomBtn = document.getElementById("deleteRoom")

            if (cookie != "authorized"){
                select.disabled = true;
                newRoomBtn.disabled = true;
                deleteRoomBtn.disabled = true;
                location.href = "/";
            } else {
                select.disabled = false;
                newRoomBtn.disabled = false;
                deleteRoomBtn.disabled = false;
            }
        }

        function initialize(){
            connectClient();
            checkCookie();            
        }

    </script>
</html>
